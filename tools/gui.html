<!DOCTYPE html>
<html>
<meta charset="utf-8">
<!-- 生产环境版本，优化了尺寸和速度 -->
<script src="https://cdn.jsdelivr.net/npm/vue"></script>
<!-- 开发环境版本，包含了有帮助的命令行警告 -->
<!-- <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script> -->
<script src="https://unpkg.com/element-ui@2.7.2/lib/index.js"></script>
<!-- <script src="https://unpkg.com/axios/dist/axios.min.js"></script> -->
<link rel="stylesheet" href="https://unpkg.com/element-ui@2.7.2/lib/theme-chalk/index.css">
<style>

</style>

<body>
    <div id="app">
        <el-row>
            <el-col :span="22" :offset="1">
                <el-card>
                    <div slot="header">订阅信息</div>
                    <el-container v-loading="loading" element-loading-text="疯狂测速中……">
                        <el-form :inline="true">
                            <el-form-item label="订阅链接：">
                                <el-input v-model="subscription" style="width: 300px"></el-input>
                            </el-form-item>
                            <el-form-item>
                                <el-button type="primary" @click="submit">提交</el-button>
                            </el-form-item>
							<el-form-item label="自定义组名：">
                                <el-input v-model="groupname" style="width: 200px"></el-input>
                            </el-form-item>
                        </el-form>
                    </el-container>
                </el-card>

                <br>

                <el-card>
                    <div slot="header">结果</div>
                    <el-container>
                        <el-table :data="result" :cell-style="colorCell" size="medium" ref="result">
                            <el-table-column label="Group" align="center" prop="group" width="300" sortable>
                            </el-table-column>
                            <el-table-column label="Remark" align="center" prop="remark" width="300" sortable>
                            </el-table-column>
                            <el-table-column label="Loss" align="center" prop="loss" width="100" sortable>
                            </el-table-column>
                            <el-table-column label="Ping" align="center" prop="ping" width="100" sortable>
                            </el-table-column>
                            <el-table-column label="AvgSpeed" align="center" prop="speed" width="150" sortable>
                            </el-table-column>
                        </el-table>
                    </el-container>
                </el-card>
            </el-col>
        </el-row>

    </div>


    <script>
        const url = ''
        const RGB = {
            "0": [255, 255, 255],
            "1": [0, 255, 0],
            "2": [255, 255, 0],
            "5": [255, 165, 0],
            "10": [255, 255, 0],
            "15": [255, 69, 0],
            "20": [255, 0, 0],
            "30": [255, 0, 0],
        }
/*
        const json =
            '[{"group":6,"remark":7,"loss":8,"ping":9,"speed":1.5},{"group":1,"remark":2,"loss":3,"ping":4,"speed":3},{"group":6,"remark":7,"loss":8,"ping":9,"speed":15},{"group":1,"remark":2,"loss":3,"ping":4,"speed":23},{"group":6,"remark":7,"loss":8,"ping":9,"speed":31},{"group":6,"remark":7,"loss":8,"ping":9,"speed":39},{"group":1,"remark":2,"loss":3,"ping":4,"speed":41}]'
*/
        let app = new Vue({
            el: '#app',
            data: {
                loading: false,
                subscription: 'https://www.google.com',
				groupname: '',
                method: 'SOCKET',
                result: [],
            },
            created() {
                document.title = 'Speedtest'
            },
            methods: {
                submit: function () {
                    this.loading = true
                    // this.result = JSON.parse(json)
                    //console.log(this.$http)
					starttest(this.subscription,this.groupname)
                },
                colorCell: function ({ row, column, rowIndex, columnIndex }) {
                    let style = 'color: black; font-weight: 600;'
                    if (columnIndex === 4) {
                        let speed = row.speed
                        //let color = this.matchColor(speed)
						let color = getSpeedColor(getSpeed(speed))
						//console.log(speed, color)

                        return style + 'background: ' + color
                    } else {
                        return style
                    }

                },
                matchColor: function (speed) {
					speed = parseFloat(getSpeed(speed))/1024
                    let rgb = [0, 0, 0]
                    if (speed <= 0) {
                        rgb = RGB['0']
                    } else if (speed > 30) {
                        rgb = RGB['30']
                    } else {
                        let match = ''
                        Object.keys(RGB).forEach(key => {
                            console.log(speed, key)
                            if (speed >= parseInt(key)) {
                                console.log(speed, parseInt(key))
                                match = key
                            }
                        })
                        rgb = RGB[match]
                    }

                    return 'rgb(' + rgb[0] + ',' + rgb[1] + ',' + rgb[2] + ')'
                }
            }
        })
    </script>
	<script language="javascript">
		var resultjson=[];
		var colorgroup=[[255,255,255],[128,255,0],[255,255,0],[255,128,192],[255,0,0]];
		var bounds=[0,64,512,4*1024,16*1024];

		function useNewPalette() {
			colorgroup=[[255,255,255],[102,255,102],[255,255,102],[255,178,102],[255,102,102],[226,140,255],[102,204,255],[102,102,255]];
			bounds=[0,64,512,4*1024,16*1024,24*1024,32*1024,40*1024];
		}
		
		function getSpeed(speed){
			var value=parseFloat(speed.toString().slice(0,-2));
			if(speed.toString().slice(-2)=="MB") value*=1024;
			return value;
		}
		
		function rgb2hex(rgb) {
			var reg=/(\d{1,3}),(\d{1,3}),(\d{1,3})/;
			var arr=reg.exec(rgb);
			function hex(x) {
				return ("0" + parseInt(x).toString(16)).slice(-2);
			}
			var _hex="#" + hex(arr[1]) + hex(arr[2]) + hex(arr[3]);
			return _hex.toUpperCase();
		}
		
		function getColor(lc,rc,level) {
			var colors=[];
			var r,g,b;
			colors.push(parseInt(lc[0]*(1-level)+rc[0]*level));
			colors.push(parseInt(lc[1]*(1-level)+rc[1]*level));
			colors.push(parseInt(lc[2]*(1-level)+rc[2]*level));
			return colors;
		}

		function getSpeedColor(speed) {
			for(var i=0;i<bounds.length-1;i++) {
				if(speed>=bounds[i]&&speed<=bounds[i+1]) return rgb2hex(getColor(colorgroup[i],colorgroup[i+1],((speed-bounds[i])/(bounds[i+1]-bounds[i]))));
			};
			return rgb2hex(colorgroup[colorgroup.length-1]);
		}
		
		function speedCompare(iCol){
			return function Compare(speed1,speed2){
				var vValue1 = parseFloat(getSpeed(speed1.cells[iCol].firstChild.nodeValue.toString()));
				var vValue2 = parseFloat(getSpeed(speed2.cells[iCol].firstChild.nodeValue.toString()));
				if(vValue1.isNaN) return -1;
				if(vValue2.isNaN) return 1;
				if(vValue1>vValue2) return 1;
				if(vValue1<vValue2) return -1;
				return 0;
			};
		}
		
		function connect(url) {
			try {
				ws = new WebSocket(url);
			} catch (ex) {
				alert('Cannot connect: ' + ex);
				return;
			}
		}

		function disconnect() {
			if (ws) {
				ws.close();
			}
		}

		function send(msg) {
			if (ws) {
				try {
					ws.send(msg);
				} catch (ex) {
					alert('Cannot send: ' + ex);
				}
			} else {
				alert('Cannot send: Not connected');
			}
		}
		
		function starttest(link,group) {
			resultjson=[];
			connect("ws://127.0.0.1:65430");
			if(ws){
				ws.addEventListener('open',function(ev){
					send(link+"^"+group);
				});
				ws.addEventListener('message',MessageEvent);
			}
		}
		
		function MessageEvent(ev) {
			var json=JSON.parse(ev.data);
			switch(json.info){
				case "gotserver":
					resultjson[parseInt(json.id)] = {"group":json.group,"remark":json.remarks,"loss":"","ping":"","speed":"0.00KB"};
					//Vue.set(resultjson,parseInt(json.id),{"group":json.group,"remark":json.remarks,"loss":"","ping":"","speed":"0.00KB"});
					break;
				case "gotping":
					resultjson[parseInt(json.id)].loss=json.loss;
					resultjson[parseInt(json.id)].ping=json.ping;
					break;
				case "gotspeed":
					resultjson[parseInt(json.id)].speed=json.speed;
					break;
				case "eof":
					app.loading=false;
					break;
				case "error":
					console.log("error:"+json.reason);
					break;
			}
			app.result=resultjson;
		}
	</script>
</body>

</html>